/*
*       Developed by Justin Mead
*       ©2010 MeadMiracle
*		www.meadmiracle.com / meadmiracle@gmail.com
*       Version 2.0
*       Testing: IE7/Windows XP
*                Firefox/Windows XP
*       Licensed under the Creative Commons GPL http://creativecommons.org/licenses/GPL/2.0/
*
*       OPTIONS LISTING:
*           *Lheight, Lwidth            - the height and width to use for the center image (landscape)
*           *Lshrink                    - the function to use when shrinking an image to a smaller size.  must take in and return an integer value. (landscape)
*           *Lzoom                      - the function to use when enlarging an image for the zoom view.  must take in and return an integer value. (landscape)
*           *Pheight, Pwidth            - the height and width to use for the center image (portrait)
*           *Pshrink                    - the function to use when shrinking an image to a smaller size.  must take in and return an integer value. (portrait)
*           *Pzoom                      - the function to use when enlarging an image for the zoom view.  must take in and return an integer value. (portrait)
*           *defaultLayout              - the layout attribute to apply when the image has no layout attribute
*           *startClass                 - the class label of the image to place in the center slot at the start of the gallery
*           *slideSpeed                 - the animation speed of sliding. use jQuery animation speed values
*           *zoomSpeed                  - the animation speed of zooming. use jQuery animation speed values
*           *gutterWidth                - the horizontal distance between each of the images. use a pixel value
*           *captionUpPath              - the path of the image to use for the "caption up" button
*           *captionUpWidth             - the pixel width of the "caption up" image
*           *captionUpHeight            - the pixel height of the "caption up" image
*           *captionUpID                - the ID attribute to use for the "caption up" image
*           *captionDownPath            - the path of the image to use for the "caption down" button
*           *captionDownWidth           - the pixel width of the "caption down" image
*           *captionDownHeight          - the pixel height of the "caption down" image
*           *captionDownID              - the ID attribute to use for the "caption down" image
*           *captionHeight              - the function to use to determine the height of the caption. takes in an integer value (usually the height of the image to caption)
                                          and returns an integer value
*           *captionStyle               - the CSS style value to apply to the captions
*           *captionClass               - the CSS class to apply to the captions
*           *captionID                  - the ID attribute to apply to the currently active caption
*           *captionTextAttribute       - the attribute containing the text to use in captions
*           *useCaptions                - allow captions to be shown
*
*       All options have default values, and as such, are optional.  Check the 'options' JSON object below to see the defaults.
*/

(function($) {
    $.gut = {};
    $.gut.center = {};
    $.gut.right = {};
    $.gut.left = {};
    $.gut.zoom = {};
    $.gut.gallery = {};

    $.gut.o = {
        container: null,
        defaultLayout: 'landscape',
        startClass: 'start',
        slideSpeed: 400,
        zoomSpeed: 600,
        gutterWidth: 20,
        showCount: 9,
        landscape: {
            height: 150,
            width: 200,
            shrink: function(dimension) { return dimension * 0.75; },
            zoom: function(dimension) { return dimension * 2; }
        },
        portrait: {
            height: 200,
            width: 150,
            shrink: function(dimension) { return dimension * 0.75; },
            zoom: function(dimension) { return dimension * 2; }
        },
        caption: {
            enabled: false,
            style: 'background-color:white; color:black; opacity: 0.6; filter: alpha(opacity = 60); font-size: 16px; text-align:center;',
            boxClass: 'mm-slider-caption-box',
            id: 'mm-slider-active-caption',
            attr: 'alt',
            height: function(zoomHeight) { return zoomHeight * 0.1; },
            hide: {
                imgsrc: 'Images/SlidingGallery/captionUpArrow.png',
                width: 24,
                height: 17,
                id: 'mm-slider-caption-hide'
            },
            show: {
                imgsrc: 'Images/SlidingGallery/captionDownArrow.png',
                width: 24,
                height: 17,
                id: 'mm-slider-caption-show'
            }
        },
        autoplay: {
            enabled: false,
            timeout: 2000,
            dir: 'right',
            handle: null
        }
    };

    $.fn.slidingGallery = function(options) {
        //global settings
        $.extend($.gut.o, options);
        //round down showCount
        if ($.gut.o.showCount % 2 == 0) $.gut.o.showCount--;
        //turn slideSpeed into a number
        if (isNaN($.gut.o.slideSpeed)) {
            switch ($.gut.o.slideSpeed) {
                case 'normal':
                    $.gut.o.slideSpeed = 400;
                    break;
                case 'fast':
                    $.gut.o.slideSpeed = 200;
                    break;
                case 'slow':
                    $.gut.o.slideSpeed = 600;
                    break;
                default:
                    $.gut.o.slideSpeed = parseInt($.gut.o.slideSpeed, 10);
            }
        }
        //eliminate overflow
        $('body').css('overflow-x', 'hidden');

        //record container handle
        $.gut.gallery.c = $(this).css('position', 'relative');

        //record gallery handle
        $.gut.gallery.i = $(this).find('img').css('cursor', 'pointer');

        //set up image position data
        $.gut.definePositions();

        //configure captions
        if ($.gut.o.caption.enabled) {
            $.gut.gallery.c.append('<img src="' + $.gut.o.caption.hide.imgsrc + '" style="width: ' + $.gut.o.caption.hide.width + '; display: none; border-width:0px;"' + 'id="' + $.gut.o.caption.hide.id + '" />').append('<img src="' + $.gut.o.caption.show.imgsrc + '" style="width: ' + $.gut.o.caption.show.width + '; display: none; border-width:0px;"' + 'id="' + $.gut.o.caption.show.id + '" />');
            $('#' + $.gut.o.caption.hide.id + ',#' + $.gut.o.caption.show.id).css('cursor', 'help');
        }

        //setup existing images
        var lastIndex = 0;
        $.gut.gallery.size = $.gut.gallery.i.each(function(i) {
            $(this).data('index', i).data('prev', i - 1).data('next', i + 1).css('position', 'absolute');
            if (($(this).data('layout') !== 'portrait') && ($(this).data('layout') !== 'landscape')) {
                $(this).data('layout', $.gut.o.defaultLayout);
            }
            lastIndex = i;
        }).hide().size();

        //if there are fewer images than needed, double the gallery
        var needed = $.gut.o.showCount * 2 - 1;
        if ($.gut.gallery.size < needed) {
            var $clones = $.gut.gallery.i.clone();
            $clones.each(function() {
                $(this).data('prev', lastIndex)
                       .data('index', ++lastIndex)
                       .data('next', lastIndex + 1)
                       .removeClass($.gut.o.startClass)
                       .appendTo($.gut.gallery.c);
            });
        }
        $.gut.gallery.i = $.gut.gallery.c.find('img').css({ padding: 0, margin: 0 }); ;
        $.gut.gallery.i.filter(function() { return $.data(this, 'index') == lastIndex; }).data('next', 0);
        $.gut.gallery.i.filter(function() { return $.data(this, 'index') == 0; }).data('prev', lastIndex);

        //set images
        var $start = $('.' + $.gut.o.startClass);
        $.gut.setCenter($start.data('index'));
        $.gut.setLeft($start.data('prev'));
        $.gut.setRight($start.data('next'));

        //bind events
        $.gut.bindSlides();
        $(window).resize(function() {
            $.gut.definePositions();
            $start = $.gut.center.i;
            $.gut.setCenter($start.data('index'));
            $.gut.setLeft($start.data('prev'));
            $.gut.setRight($start.data('next'));
        }).resize();

        if ($.gut.o.autoplay.enabled) {
            var autoplayFunc = null;
            if ($.gut.o.autoplay.dir === 'left') {
                autoplayFunc = function() {
                    $.gut.slideLeft(1);
                };
            } else {
                autoplayFunc = function() {
                    $.gut.slideRight(1);
                };
            }
            $.gut.o.autoplay.handle = setInterval($.gut.autoPlayFunc, $.gut.o.autoplay.timeout);
        }

        //return the objects (for chaining purposes)
        return $(this);
    };

    $.gut.bindSlides = function() {
        $.each($.gut.left.i, function(i) { this.one('click', function() { $.gut.slideRight(i + 1); }) });
        $.each($.gut.right.i, function(i) { this.one('click', function() { $.gut.slideLeft(i + 1); }) });
        $.gut.center.i.one('click', $.gut.zoomIn).css('z-index', 0);
        if ($.gut.o.autoplay.enabled) {
            $.gut.gallery.i.hover(function() {
                clearInterval($.gut.o.autoplay.handle);
                $.gut.o.autoplay.handle = null;
            }, function() {
                if ($.gut.o.autoplay.handle != null) clearInterval($.gut.o.autoplay.handle);
                $.gut.o.autoplay.handle = setInterval($.gut.autoPlayFunc, $.gut.o.autoplay.timeout);
            });
        }
    };

    $.gut.autoPlayFunc = function() {
        if ($.gut.o.autoplay.dir === 'left') {
            $.gut.slideLeft(1);
        } else {
            $.gut.slideRight(1);
        }
    };

    $.gut.slideRight = function(dist) {
        //unbind so that nothing else can happen while we're sliding
        $.gut.gallery.i.unbind();

        //set the speed (convenience var)
        var speed = $.gut.o.slideSpeed;

        //shift all array values to the right
        var offScreen = [];
        var toSet = [];
        for (var i = 0; i < dist; i++) {
            offScreen.push($.gut.right.i.pop());
            $.gut.right.i.unshift($.gut.center.i);
            $.gut.center.i = $.gut.left.i.shift();
            var incoming = $.gut.gallery.i.filter(function() { return $.data(this, 'index') == $.gut.left.i[$.gut.left.i.length - 1].data('prev'); });
            $.gut.left.i.push(incoming);
            toSet.push(incoming);
        }

        //make sure all incoming photos are in place to be moved
        for (var j = 0; j < toSet.length; j++) {
            var sIndex = $.gut.gallery.sl - 1;
            toSet[j].css({ 'top': $.gut.left.l[sIndex].t,
                'left': $.gut.left.l[sIndex].l($.gut.center.i, $.gut.leftPrev($.gut.center.i.data('index'), toSet[j].data('index'))),
                'height': $.gut.left.l[sIndex].h,
                'width': $.gut.left.l[sIndex].w
            });
        }

        //we'll use this to set up animation properties
        var props = {};
        //time to start animating! we'll start on the left. note that we don't animate the far left slot,
        //as it should just be "placed" in storage
        $.each($.gut.left.i, function(j) {
            if (j + 1 < $.gut.gallery.sl) {
                //figure the new css properties
                props = $.gut.calcProps('left', this, j);
                //fade in if it's an incoming left image
                if (j + dist + 1 >= $.gut.gallery.sl) props.opacity = 'show';
                this.animate(props, speed, 'linear');
            }
        });

        //and now for the center
        $.gut.center.i.animate($.gut.calcProps('center', $.gut.center.i), speed, 'linear');

        //the right
        $.each($.gut.right.i, function(j) {
            //figure the new css properties
            props = $.gut.calcProps('right', this, j);

            //if this is the last image on the right, we want to animate to hidden
            if (j + 1 == $.gut.gallery.sl) props.opacity = 'hide';

            //do the slide
            $.gut.crossCenterSlide(this, dist, speed, props, j);
        });

        //finally, any that got popped off the end, except the very last one (which is hidden anyways)
        for (var j = 1; j < offScreen.length; j++) {
            props = $.gut.calcProps('rightStore', offScreen[j], j);
            props.opacity = 'hide';
            offScreen[j].animate(props, speed / (j + 1), 'linear');
        }

        //rebind events
        $.gut.bindSlides();
    };

    $.gut.slideLeft = function(dist) {
        //unbind so that nothing else can happen while we're sliding
        $.gut.gallery.i.unbind();

        //set the speed (convenience var)
        var speed = $.gut.o.slideSpeed;

        //shift all array values to the left
        var offScreen = [];
        var toSet = [];
        for (var i = 0; i < dist; i++) {
            offScreen.push($.gut.left.i.pop());
            $.gut.left.i.unshift($.gut.center.i);
            $.gut.center.i = $.gut.right.i.shift();
            var incoming = $.gut.gallery.i.filter(function() { return $.data(this, 'index') == $.gut.right.i[$.gut.right.i.length - 1].data('next'); });
            $.gut.right.i.push(incoming);
            toSet.push(incoming);
        }

        //make sure all incoming photos are in place to be moved
        for (var j = 0; j < toSet.length; j++) {
            var sIndex = $.gut.gallery.sl - 1;
            toSet[j].css({ 'top': $.gut.right.l[sIndex].t,
                'left': $.gut.right.l[sIndex].l($.gut.center.i, $.gut.rightPrev($.gut.center.i.data('index'), toSet[j].data('index'))),
                'height': $.gut.right.l[sIndex].h,
                'width': $.gut.right.l[sIndex].w
            });
        }

        //we'll use this to set up animation properties
        var props = {};
        //time to start animating! we'll start on the right. note that we don't animate the far right slot,
        //as it should just be "placed" in storage
        $.each($.gut.right.i, function(j) {
            if (j + 1 < $.gut.gallery.sl) {
                props = $.gut.calcProps('right', this, j);
                //fade in if it's an incoming right image
                if (j + dist + 1 >= $.gut.gallery.sl) props.opacity = 'show';
                this.animate(props, speed, 'linear');
            }
        });

        //and now for the center
        $.gut.center.i.animate($.gut.calcProps('center', $.gut.center.i), speed, 'linear');

        //the left
        $.each($.gut.left.i, function(j) {
            //figure the new css properties
            props = $.gut.calcProps('left', this, j);
            //if this is the last image on the left, we want to animate to hidden
            if (j + 1 == $.gut.gallery.sl) props.opacity = 'hide';

            //do the slide
            $.gut.crossCenterSlide(this, dist, speed, props, j);
        });

        //finally, any that got popped off the end, except the very last one (which is hidden anyways)
        for (var j = 1; j < offScreen.length; j++) {
            props = $.gut.calcProps('leftStore', offScreen[j], j);
            props.opacity = 'hide';
            offScreen[j].animate(props, speed / (j + 1), 'linear');
        }

        //rebind events
        $.gut.bindSlides();
    };

    $.gut.crossCenterSlide = function(elem, dist, speed, props, j) {
        //if this image is crossing center, we need to animate to center first, then to the new position
        if (dist > 1 && j <= dist - 2) {
            var centerProps = $.gut.calcProps('center', elem);
            var speedAfterCenter = (speed / dist) * (j + 1);
            elem.data('afterProps', props);
            elem.animate(centerProps, speed - speedAfterCenter, function() {
                $(this).animate($(this).data('afterProps'), speedAfterCenter, 'linear');
                $(this).data('afterProps', '');
            });
        } else {
            elem.animate(props, speed, 'linear');
        }
    };

    $.gut.calcProps = function(dir, elem, j) {
        var left = 0;
        var pi = {};
        var li = {};
        var index = 0;
        var leftFunc = null;
        switch (dir) {
            case 'left':
                leftFunc = $.gut.leftPrev;
                pi = $.gut.left.p[j];
                li = $.gut.left.l[j];
                index = $.gut.left.i[j].data('index');
                break;
            case 'right':
                leftFunc = $.gut.rightPrev;
                pi = $.gut.right.p[j];
                li = $.gut.right.l[j];
                index = $.gut.right.i[j].data('index');
                break;
            case 'leftStore':
                li = $.gut.left.l[$.gut.gallery.sl - 1];
                pi = $.gut.left.p[$.gut.gallery.sl - 1];
                leftFunc = $.gut.leftPrev;
                index = $.gut.left.i[$.gut.gallery.sl - 1].data('index');
                break;
            case 'rightStore':
                li = $.gut.left.l[$.gut.gallery.sl - 1];
                pi = $.gut.left.p[$.gut.gallery.sl - 1];
                leftFunc = $.gut.leftPrev;
                index = $.gut.left.i[$.gut.gallery.sl - 1].data('index');
                break;
            case 'center':
                pi = $.gut.center.p;
                li = $.gut.center.l;
                break;
            case 'zoom':
                pi = $.gut.zoom.p;
                li = $.gut.zoom.l;
                break;
        }
        if (dir !== 'center' && dir !== 'zoom') {
            left = li.l($.gut.center.i, leftFunc($.gut.center.i.data('index'), index));
        } else {
            switch (elem.data('layout')) {
                case 'landscape':
                    left = li.l;
                    break;
                case 'portrait':
                    left = pi.l;
                    break;
                default:
                    left = li.l;
                    break;
            }
        }
        switch (elem.data('layout')) {
            case 'landscape':
                return { 'top': li.t,
                    'left': left,
                    'height': li.h,
                    'width': li.w
                }
                break;
            case 'portrait':
                return { 'top': pi.t,
                    'left': left,
                    'height': pi.h,
                    'width': pi.w
                }
                break;
            default:
                return { 'top': li.t,
                    'left': left,
                    'height': li.h,
                    'width': li.w
                }
                break;
        }
    };

    $.gut.zoomIn = function() {
        //unbind everything while we're zoomed
        $.gut.gallery.i.unbind();

        var zi = null;
        switch ($.gut.center.i.data('layout')) {
            case 'landscape':
                zi = $.gut.zoom.l;
                break;
            case 'portrait':
                zi = $.gut.zoom.p;
                break;
            default:
                zi = $.gut.zoom.l;
                break;
        }

        var props = $.gut.calcProps('zoom', $.gut.center.i);
        $.gut.center.i.css('z-index', '99').animate(props, $.gut.o.zoomSpeed, 'linear', function() {
            $.gut.center.i.one('click', $.gut.zoomOut);
            if ($.gut.o.caption.enabled) {
                $('#' + $.gut.o.caption.show.id).css({
                    'height': 0,
                    'top': zi.t + parseInt($.gut.center.i.css('borderTopWidth'), 10),
                    'left': zi.l + (zi.w - $.gut.o.caption.show.width) + parseInt($.gut.center.i.css('borderLeftWidth'), 10),
                    'z-index': 100,
                    'position': 'absolute'
                }).show().animate({ 'height': $.gut.o.caption.show.height }, 'fast', 'linear', function() {
                    $('#' + $.gut.o.caption.show.id).one('click', $.gut.capReveal);
                });
            }
        });
    };


    $.gut.zoomOut = function() {
        if ($.gut.o.caption.enabled) {
            $('#' + $.gut.o.caption.show.id).animate({ 'height': 0 }, 50, 'linear', $.gut.zoomOutBody).unbind();
        } else {
            $.gut.zoomOutBody();
        }
        if ($.gut.o.autoplay.enabled) {
            if ($.gut.o.autoplay.handle != null) clearInterval($.gut.o.autoplay.handle);
            $.gut.o.autoplay.handle = setInterval($.gut.autoPlayFunc, $.gut.o.autoplay.timeout);
        }
    };

    $.gut.zoomOutBody = function() {
        var props = $.gut.calcProps('center', $.gut.center.i);
        $.gut.center.i.animate(props, $.gut.o.zoomSpeed, 'linear', $.gut.bindSlides);
    };
    
    $.gut.capReveal = function() {
        //unbind the image
        $.gut.center.i.unbind();

        //conveniece var for layout
        var layout = $.gut.center.i.data('layout');

        //create the caption box
        $.gut.gallery.c.append($.gut.capBox($.gut.center.i.attr($.gut.o.caption.attr)));

        //place the box and animate it to shown
        $('#' + $.gut.o.caption.id).css($.gut.capCss(layout, 'boxLocation'))
                                        .animate($.gut.capCss(layout, 'height'), 'normal', 'linear');
        //animate the capShowImg to hidden
        $('#' + $.gut.o.caption.show.id).animate($.gut.capCss(layout, 'capShowImgHide'), 'normal', 'linear', function() { $('#' + $.gut.o.caption.show.id).hide(); });

        //animate the capHideImg to shown
        $('#' + $.gut.o.caption.hide.id).css($.gut.capCss(layout, 'capHideImg')).show().animate($.gut.capCss(layout, 'capHideImgReveal'), 'normal', 'linear', function() {
            $('#' + $.gut.o.caption.hide.id).one('click', function() {
                $.gut.capHide(false);
            });
            $.gut.center.i.one('click', function() {
                $.gut.capHide(true);
            });
        });
    };
    
    $.gut.capHide = function(unzoom) {
        //conveniece var for layout
        var layout = $.gut.center.i.data('layout');
        
        //hide the caption box
        $('#' + $.gut.o.caption.id).animate({ 'height': 0 }, 'normal', 'linear', function() { $('#' + $.gut.o.caption.id).remove(); });

        //hide the "hide" img
        $('#' + $.gut.o.caption.hide.id).animate($.gut.capCss(layout, 'capHideImgHide'), 'normal', 'linear', function() {
            $('#' + $.gut.o.caption.hide.id).hide();
        });

        //show the cap reveal img
        $('#' + $.gut.o.caption.show.id).show().animate($.gut.capCss(layout, 'capShowImgReveal'), 'normal', 'linear', function() {
            if (unzoom) {
                $('#' + $.gut.o.caption.hide.id).unbind();
                $.gut.zoomOut();
            } else {
                $('#' + $.gut.o.caption.show.id).one('click', $.gut.capReveal);
                $.gut.center.i.one('click', $.gut.zoomOut);
            }
        });
    };

    $.gut.capBox = function(cap) {
        return '<span id="' + $.gut.o.caption.id + '" style="' + $.gut.o.caption.style + '" class="' + $.gut.o.caption.boxClass + '">' + cap + '</span>';
    };

    $.gut.capCss = function(layout, type) {
        var zi = null;
        switch (layout) {
            case 'landscape':
                zi = $.gut.zoom.l;
                break;
            case 'portrait':
                zi = $.gut.zoom.p;
                break;
            default:
                zi = $.gut.zoom.l;
                break;
        }
        switch (type) {
            case 'boxLocation':
                return {
                    'top': zi.t + parseInt($.gut.center.i.css('borderTopWidth'), 10),
                    'left': zi.l + parseInt($.gut.center.i.css('borderLeftWidth'), 10),
                    'width': zi.w,
                    'height': 0,
                    'position': 'absolute',
                    'z-index': '100'
                };
                break;
            case 'height':
                return { 'height': Math.round($.gut.o.caption.height(zi.h)) };
                break;
            case 'capShowImg':
                break;
            case 'capHideImg':
                return {
                    'top': zi.t + $.gut.o.caption.show.height + parseInt($.gut.center.i.css('borderTopWidth'), 10),
                    'left': zi.l + (zi.w - $.gut.o.caption.hide.width) + parseInt($.gut.center.i.css('borderLeftWidth'), 10),
                    'height': 0,
                    'position': 'absolute',
                    'z-index': '100'
                };
                break;
            case 'capShowImgReveal':
                return {
                    'height': $.gut.o.caption.show.height,
                    'top': zi.t + parseInt($.gut.center.i.css('borderTopWidth'), 10)
                };
                break;
            case 'capHideImgReveal':
                return {
                    'top': zi.t + (Math.round($.gut.o.caption.height(zi.h))) + parseInt($.gut.center.i.css('borderTopWidth'), 10),
                    'height': $.gut.o.caption.hide.height
                };
                break;
            case 'capShowImgHide':
                return {
                    'height': 0,
                    'top': zi.t + (Math.round($.gut.o.caption.height(zi.h))) + parseInt($.gut.center.i.css('borderTopWidth'), 10)
                };
                break;
            case 'capHideImgHide':
                return {
                    'top': zi.t + $.gut.o.caption.show.height + parseInt($.gut.center.i.css('borderTopWidth'), 10),
                    'height': 0
                };
                break;
        }
    };

    //initial set up for center image positioning
    $.gut.setCenter = function(index) {
        $.gut.center.i = $.gut.gallery.i.filter(function() { return $.data(this, 'index') == index; });
        switch ($.gut.center.i.data('layout')) {
            case 'landscape':
                $.gut.center.i.css({
                    'top': $.gut.center.l.t,
                    'left': $.gut.center.l.l,
                    'height': $.gut.center.l.h,
                    'width': $.gut.center.l.w
                });
                break;
            case 'portrait':
                $.gut.center.i.css({
                    'top': $.gut.center.p.t,
                    'left': $.gut.center.p.l,
                    'height': $.gut.center.p.h,
                    'width': $.gut.center.p.w
                });
                break;
            default:
                $.gut.center.i.css({
                    'top': $.gut.center.l.t,
                    'left': $.gut.center.l.l,
                    'height': $.gut.center.l.h,
                    'width': $.gut.center.l.w
                });
                break;
        }
        $.gut.center.i.show();
    };

    $.gut.setRight = function(index) {
        $.gut.right.i = [];
        for (var i = 0; i < $.gut.gallery.sl; i++) {
            var temp = $.gut.gallery.i.filter(function() { return $.data(this, 'index') == index; });
            $.gut.right.i.push(temp);
            index = temp.data('next');
        }
        for (var i = 0; i < $.gut.gallery.sl; i++) {
            var $prev = $.gut.rightPrev($.gut.center.i.data('index'), $.gut.right.i[i].data('index'));
            switch ($.gut.right.i[i].data('layout')) {
                case 'landscape':
                    $.gut.right.i[i].css({
                        'top': $.gut.right.l[i].t,
                        'height': $.gut.right.l[i].h,
                        'width': $.gut.right.l[i].w,
                        'left': $.gut.right.l[i].l($.gut.center.i, $prev)
                    });
                    break;
                case 'portrait':
                    $.gut.right.i[i].css({
                        'top': $.gut.right.p[i].t,
                        'height': $.gut.right.p[i].h,
                        'width': $.gut.right.p[i].w,
                        'left': $.gut.right.p[i].l($.gut.center.i, $prev)
                    });
                    break;
                default:
                    $.gut.right.i[i].css({
                        'top': $.gut.right.l[i].t,
                        'height': $.gut.right.l[i].h,
                        'width': $.gut.right.l[i].w,
                        'left': $.gut.right.l[i].l($.gut.center.i, $prev)
                    });
                    break;
            }
            if (i + 1 != $.gut.gallery.sl) $.gut.right.i[i].show();
        }
    };

    $.gut.setLeft = function(index) {
        $.gut.left.i = [];
        for (var i = 0; i < $.gut.gallery.sl; i++) {
            var temp = $.gut.gallery.i.filter(function() { return $.data(this, 'index') == index; });
            $.gut.left.i.push(temp);
            index = temp.data('prev');
        }
        for (var i = 0; i < $.gut.gallery.sl; i++) {
            var $prev = $.gut.leftPrev($.gut.center.i.data('index'), $.gut.left.i[i].data('index'));
            switch ($.gut.left.i[i].data('layout')) {
                case 'landscape':
                    $.gut.left.i[i].css({
                        'top': $.gut.left.l[i].t,
                        'height': $.gut.left.l[i].h,
                        'width': $.gut.left.l[i].w,
                        'left': $.gut.left.l[i].l($.gut.center.i, $prev)
                    });
                    break;
                case 'portrait':
                    $.gut.left.i[i].css({
                        'top': $.gut.left.p[i].t,
                        'height': $.gut.left.p[i].h,
                        'width': $.gut.left.p[i].w,
                        'left': $.gut.left.p[i].l($.gut.center.i, $prev)
                    });
                    break;
                default:
                    $.gut.left.i[i].css({
                        'top': $.gut.left.l[i].t,
                        'height': $.gut.left.l[i].h,
                        'width': $.gut.left.l[i].w,
                        'left': $.gut.left.l[i].l($.gut.center.i, $prev)
                    });
                    break;
            }
            if (i + 1 != $.gut.gallery.sl) $.gut.left.i[i].show();
        }
    };

    $.gut.definePositions = function() {
        //determine container dimensions
        var container = $.gut.gallery.c;
        if (container[0].tagName == 'BODY') {
            container = $(window);
        }
        var Gheight = container.height();
        var Gwidth = container.width();

        $.gut.left.l = [];
        $.gut.left.p = [];
        $.gut.right.l = [];
        $.gut.right.p = [];

        //determine center dimensions and positions
        $.gut.center.l = {
            h: Math.round($.gut.o.landscape.height),
            w: Math.round($.gut.o.landscape.width),
            t: Math.round(Gheight / 2) - ($.gut.o.landscape.height / 2),
            l: Math.round(Gwidth / 2) - ($.gut.o.landscape.width / 2)
        };
        $.gut.center.p = {
            h: Math.round($.gut.o.portrait.height),
            w: Math.round($.gut.o.portrait.width),
            t: Math.round(Gheight / 2) - ($.gut.o.portrait.height / 2),
            l: Math.round(Gwidth / 2) - ($.gut.o.portrait.width / 2)
        };

        //determine center zoom dimensions and positions
        $.gut.zoom.l = {
            h: Math.round($.gut.o.landscape.zoom($.gut.center.l.h)),
            w: Math.round($.gut.o.landscape.zoom($.gut.center.l.w)),
            t: Math.round((Gheight / 2) - (Math.round($.gut.o.landscape.zoom($.gut.center.l.h)) / 2)),
            l: Math.round((Gwidth / 2) - (Math.round($.gut.o.landscape.zoom($.gut.center.l.w)) / 2))
        };
        $.gut.zoom.p = {
            h: Math.round($.gut.o.portrait.zoom($.gut.center.p.h)),
            w: Math.round($.gut.o.portrait.zoom($.gut.center.p.w)),
            t: Math.round((Gheight / 2) - (Math.round($.gut.o.portrait.zoom($.gut.center.p.h)) / 2)),
            l: Math.round((Gwidth / 2) - (Math.round($.gut.o.portrait.zoom($.gut.center.p.w)) / 2))
        };

        //convenience var giving how many position slots we need on either side of center
        $.gut.gallery.sl = ($.gut.o.showCount + 1) / 2;

        //base landscape image pos/dim object that we'll use to make the rest
        var trueL = {
            h: Math.round($.gut.o.landscape.shrink($.gut.o.landscape.height)),
            w: Math.round($.gut.o.landscape.shrink($.gut.o.landscape.width)),
            t: Math.round($.gut.center.l.t + (($.gut.o.landscape.height - $.gut.o.landscape.shrink($.gut.o.landscape.height)) / 2)),
            l: $.gut.leftMovingLeft
        };

        //base portrait image pos/dim object that we'll use to make the rest
        var trueP = {
            h: Math.round($.gut.o.portrait.shrink($.gut.o.portrait.height)),
            w: Math.round($.gut.o.portrait.shrink($.gut.o.portrait.width)),
            t: Math.round($.gut.center.p.t + (($.gut.o.portrait.height - $.gut.o.portrait.shrink($.gut.o.portrait.height)) / 2)),
            l: $.gut.leftMovingLeft
        };

        //turn true landscape & portrait into something we can modify
        var l = $.extend(true, {}, trueL);
        var p = $.extend(true, {}, trueP);

        //add the first slots to the left
        $.gut.left.l.push($.extend(true, {}, l));
        $.gut.left.p.push($.extend(true, {}, p));

        //add additional slots to the left until we're full
        for (var i = 1; i < $.gut.gallery.sl; i++) {
            //landscape
            var newH = Math.round($.gut.o.landscape.shrink(l.h));
            l.t = Math.round(l.t + ((l.h - newH) / 2));
            l.w = Math.round($.gut.o.landscape.shrink(l.w));
            l.h = newH;
            $.gut.left.l.push($.extend(true, {}, l));

            //portrait
            newH = Math.round($.gut.o.portrait.shrink(p.h));
            p.t = Math.round(p.t + ((p.h - newH) / 2));
            p.w = Math.round($.gut.o.portrait.shrink(p.w));
            p.h = newH;
            $.gut.left.p.push($.extend(true, {}, p));
        }

        //reset landscape obj to true landscape and portrait to true portrait
        l = $.extend(true, {}, trueL);
        p = $.extend(true, {}, trueP);
        //redefine the left calc function - we're moving to the right now
        l.l = $.gut.leftMovingRight;
        p.l = $.gut.leftMovingRight;

        //add the first slots to the right
        $.gut.right.l.push($.extend(true, {}, l));
        $.gut.right.p.push($.extend(true, {}, p));

        //add additional slots to the right until we're full
        for (var i = 1; i < $.gut.gallery.sl; i++) {
            //landscape
            var newH = Math.round($.gut.o.landscape.shrink(l.h));
            l.t = Math.round(l.t + ((l.h - newH) / 2));
            l.w = Math.round($.gut.o.landscape.shrink(l.w));
            l.h = newH;
            $.gut.right.l.push($.extend(true, {}, l));

            //portrait
            newH = Math.round($.gut.o.portrait.shrink(p.h));
            p.t = Math.round(p.t + ((p.h - newH) / 2));
            p.w = Math.round($.gut.o.portrait.shrink(p.w));
            p.h = newH;
            $.gut.right.p.push($.extend(true, {}, p));
        }
    };

    $.gut.leftMovingLeft = function(center, prevAndSelf) {
        var left = 0;
        switch (center.data('layout')) {
            case 'landscape':
                left = $.gut.center.l.l;
                break;
            case 'portrait':
                left = $.gut.center.p.l;
                break;
            default:
                left = $.gut.center.l.l;
                break;
        }
        $.each(prevAndSelf.get().reverse(), function(i) {
            switch ($(this).data('layout')) {
                case 'landscape':
                    left = left - ($.gut.left.l[i].w + $.gut.o.gutterWidth);
                    break;
                case 'portrait':
                    left = left - ($.gut.left.p[i].w + $.gut.o.gutterWidth);
                    break;
                default:
                    left = left - ($.gut.left.l[i].w + $.gut.o.gutterWidth);
                    break;
            }
        });
        return left;
    };

    $.gut.leftMovingRight = function(center, prev) {
        var left = 0;
        switch (center.data('layout')) {
            case 'landscape':
                left = $.gut.center.l.l + $.gut.center.l.w + $.gut.o.gutterWidth;
                break;
            case 'portrait':
                left = $.gut.center.p.l + $.gut.center.p.w + $.gut.o.gutterWidth;
                break;
            default:
                left = $.gut.center.l.l + $.gut.center.l.w + $.gut.o.gutterWidth;
                break;
        }
        prev.each(function(i) {
            switch ($(this).data('layout')) {
                case 'landscape':
                    left = left + ($.gut.right.l[i].w + $.gut.o.gutterWidth);
                    break;
                case 'portrait':
                    left = left + ($.gut.right.p[i].w + $.gut.o.gutterWidth);
                    break;
                default:
                    left = left + ($.gut.right.l[i].w + $.gut.o.gutterWidth);
                    break;
            }
        });
        return left;
    };

    $.gut.leftPrev = function(centerIndex, index) {
        var wrap = centerIndex < index;
        return $.gut.gallery.i.filter(function() {
            var currIndex = $.data(this, 'index');
            if (wrap) {
                return currIndex >= index || (currIndex < index && currIndex < centerIndex);
            } else {
                return currIndex >= index && currIndex < centerIndex;
            }
        });
    };

    $.gut.rightPrev = function(centerIndex, index) {
        var wrap = centerIndex > index;
        return $.gut.gallery.i.filter(function() {
            var currIndex = $.data(this, 'index');
            if (wrap) {
                return currIndex < index || (currIndex > index && currIndex > centerIndex);
            } else {
                return currIndex < index && currIndex > centerIndex;
            }
        });
    };
})(jQuery);